/*
INSERÇÃO DO CSV
*/
CREATE TEMP TABLE T
(
    area VARCHAR(100),
    country_code VARCHAR(3),
    year INTEGER,
    area_type VARCHAR(20),
    continent VARCHAR(20),
    ember_region VARCHAR(50),
    eu NUMERIC(3,1),
    oecd NUMERIC(3,1),
    g20 NUMERIC(3,1),
    g7 NUMERIC(3,1),
    asean NUMERIC(3,1),
    category VARCHAR(50),
    subcategory VARCHAR(50),
    variable VARCHAR(50),
    unit VARCHAR(10),
    value DOUBLE PRECISION,
    yoy_absolute_change DOUBLE PRECISION,
    yoy_percent_change DOUBLE PRECISION
);

COPY T
FROM '/tmp/energias.csv'
WITH (format csv, HEADER true);

SELECT DISTINCT AREA,
				AREA_TYPE,
				EMBER_REGION,
				EU,
				OECD,
				G20,
				G7,
				ASEAN
FROM T
ORDER BY AREA;

select distinct CATEGORY,
				SUBCATEGORY,
				VARIABLE,
				UNIT
FROM T
WHERE UNIT != '%'
	AND SUBCATEGORY != 'Aggregate fuel'
	AND SUBCATEGORY NOT LIKE '%per capita%'
	AND VARIABLE NOT LIKE '%Total%'
ORDER BY CATEGORY, UNIT, VARIABLE;

SELECT DISTINCT VARIABLE FROM T;

SELECT DISTINCT VARIABLE
FROM T
WHERE VARIABLE NOT LIKE '% and %' AND VARIABLE NOT LIKE '&Total%'
ORDER BY VARIABLE;

SELECT DISTINCT CATEGORY,
				SUBCATEGORY,
				VARIABLE
FROM T
WHERE CATEGORY LIKE '%Capacity%' OR CATEGORY LIKE '%generation%' OR CATEGORY LIKE '%emissions%'
ORDER BY CATEGORY, SUBCATEGORY;

SELECT * FROM T
WHERE CATEGORY LIKE '%Capacity%' OR CATEGORY LIKE '%generation%' OR CATEGORY LIKE '%emissions%';

SELECT DISTINCT CATEGORY,
UNIT
FROM T
ORDER BY CATEGORY, UNIT;

SELECT DISTINCT AREA,
				CATEGORY,
				YEAR,
				SUM(VALUE) AS VALOR_TOTAL,
				UNIT
FROM T
WHERE CATEGORY = 'Electricity demand'
GROUP BY AREA, CATEGORY, YEAR, UNIT
ORDER BY CATEGORY;
				

/*
POPULAÇÃO DA ENTIDADE AREA
*/
-- Inserção de áreas com código
INSERT INTO AREA
SELECT DISTINCT	COUNTRY_CODE,
		AREA,
		AREA_TYPE,
		CONTINENT
FROM T
WHERE COUNTRY_CODE IS NOT NULL;

-- Inserção de áreas sem código
INSERT INTO AREA
SELECT DISTINCT SA.SIGLA,
		T.AREA,
		T.AREA_TYPE,
		T.CONTINENT
FROM T INNER JOIN SIGLA_ARTIFICIAL AS SA
ON T.AREA = SA.NOME;

/*
POPULAÇÃO DA ENTIDADE ENERGIA
*/
INSERT INTO ENERGIA (CATEGORIA, SUBCATEGORIA, VARIAVEL)
SELECT DISTINCT CATEGORY,
		SUBCATEGORY,
		VARIABLE
FROM T;

-- Verificar diferentes unidades
SELECT DISTINCT UNIT FROM T
ORDER BY UNIT;

-- Verificar aplicações de cada unidade
SELECT DISTINCT CATEGORY,
		SUBCATEGORY,
		VARIABLE,
		UNIT
FROM T
ORDER BY CATEGORY, UNIT, SUBCATEGORY;

/*
POPULAÇÃO DA ENTIDADE PAIS_ENERGIA
*/
INSERT INTO PAIS_ENERGIA
SELECT	E.ID,
		CASE
			WHEN COUNTRY_CODE IS NOT NULL THEN COUNTRY_CODE
			ELSE SA.SIGLA
		END AS SIGLA_AREA,
		COALESCE(VALUE, 0) AS VALUE,
		UNIT,
		YEAR
FROM T
	LEFT JOIN SIGLA_ARTIFICIAL AS SA
		ON T.AREA = SA.NOME
	LEFT JOIN ENERGIA AS E
		ON T.CATEGORY = E.CATEGORIA
		AND T.SUBCATEGORY = E.SUBCATEGORIA
		AND T.VARIABLE = E.VARIAVEL
ORDER BY SIGLA_AREA, YEAR;

SELECT * FROM SIGLA_ARTIFICIAL;

SELECT *
FROM PAIS_ENERGIA PE
JOIN AREA A
ON PE.SIGLA_AREA = A.SIGLA
JOIN ENERGIA E
ON PE.ID_ENERGIA = E.ID
WHERE TIPO != 'Country';

DROP TABLE T;