/*
INSERÇÃO DO CSV
*/
CREATE TEMP TABLE T
(
    area VARCHAR(100),
    country_code VARCHAR(3),
    year INTEGER,
    area_type VARCHAR(20),
    continent VARCHAR(20),
    ember_region VARCHAR(50),
    eu NUMERIC(3,1),
    oecd NUMERIC(3,1),
    g20 NUMERIC(3,1),
    g7 NUMERIC(3,1),
    asean NUMERIC(3,1),
    category VARCHAR(50),
    subcategory VARCHAR(50),
    variable VARCHAR(50),
    unit VARCHAR(10),
    value DOUBLE PRECISION,
    yoy_absolute_change DOUBLE PRECISION,
    yoy_percent_change DOUBLE PRECISION
);

COPY T
FROM '/tmp/energia.csv'
WITH (format csv, HEADER true);

/*
POPULAÇÃO DA ENTIDADE AREA
*/
-- Inserção de áreas com código
INSERT INTO AREA
SELECT DISTINCT	COUNTRY_CODE,
		AREA,
		AREA_TYPE,
		CONTINENT
FROM T
WHERE COUNTRY_CODE IS NOT NULL;

-- Inserção de áreas sem código
INSERT INTO AREA
SELECT DISTINCT SA.SIGLA,
		T.AREA,
		T.AREA_TYPE,
		T.CONTINENT
FROM T INNER JOIN SIGLA_ARTIFICIAL AS SA
ON T.AREA = SA.NOME;

/*
POPULAÇÃO DA ENTIDADE ENERGIA
*/
INSERT INTO ENERGIA (CATEGORIA, SUBCATEGORIA, VARIAVEL)
SELECT DISTINCT CATEGORY,
		SUBCATEGORY,
		VARIABLE
FROM T;

-- Verificar diferentes unidades
SELECT DISTINCT UNIT FROM T
ORDER BY UNIT;

-- Verificar aplicações de cada unidade
SELECT DISTINCT CATEGORY,
		SUBCATEGORY,
		VARIABLE,
		UNIT
FROM T
ORDER BY CATEGORY, UNIT, SUBCATEGORY;

/*
POPULAÇÃO DA ENTIDADE GERACAO_ENERGIA
*/
INSERT INTO GERACAO_ENERGIA
SELECT	E.ID,
		CASE
			WHEN COUNTRY_CODE IS NOT NULL THEN COUNTRY_CODE
			ELSE SA.SIGLA
		END AS SIGLA_AREA,
		COALESCE(VALUE, 0) AS VALUE,
		UNIT,
		YEAR
FROM T
	LEFT JOIN SIGLA_ARTIFICIAL AS SA
		ON T.AREA = SA.NOME
	LEFT JOIN ENERGIA AS E
		ON T.CATEGORY = E.CATEGORIA
		AND T.SUBCATEGORY = E.SUBCATEGORIA
		AND T.VARIABLE = E.VARIAVEL
ORDER BY SIGLA_AREA, YEAR;

DROP TABLE T;